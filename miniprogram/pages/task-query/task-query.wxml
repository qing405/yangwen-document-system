<!--pages/task-query/task-query.wxml-->
<view class="container">
  <!-- 头部导航 -->
  <view class="header">
    <view class="header-left" bindtap="goBack">
      <icon name="arrow-left" size="20" color="#FFFFFF"></icon>
    </view>
    <view class="header-title">
      <text>任务查询</text>
    </view>
    <view class="header-right">
      <view class="view-toggle">
        <view class="toggle-btn {{viewMode === 'list' ? 'active' : ''}}" bindtap="switchViewMode" data-mode="list">
          <icon name="list" size="16" color="{{viewMode === 'list' ? '#FFFFFF' : '#CBD5E1'}}"></icon>
        </view>
        <view class="toggle-btn {{viewMode === 'grid' ? 'active' : ''}}" bindtap="switchViewMode" data-mode="grid">
          <icon name="grid" size="16" color="{{viewMode === 'grid' ? '#FFFFFF' : '#CBD5E1'}}"></icon>
        </view>
      </view>
    </view>
  </view>

  <!-- 搜索栏 -->
  <view class="search-section">
    <view class="search-bar">
      <icon name="search" size="16" color="#64748B"></icon>
      <input 
        class="search-input" 
        placeholder="搜索任务..." 
        value="{{searchKeyword}}"
        bindinput="onSearch"
      />
    </view>
  </view>

  <!-- 筛选面板 -->
  <view wx:if="{{showFilterPanel}}" class="filter-panel">
    <view class="filter-content">
      <!-- 状态筛选 -->
      <view class="filter-section">
        <text class="filter-title">状态筛选</text>
        <view class="filter-options">
          <view 
            class="filter-option {{selectedStatus === item.value ? 'active' : ''}}"
            wx:for="{{statuses}}" 
            wx:key="value"
            bindtap="onStatusFilter"
            data-status="{{item.value}}"
          >
            <text>{{item.label}}</text>
          </view>
        </view>
      </view>
      
      <!-- 优先级筛选 -->
      <view class="filter-section">
        <text class="filter-title">优先级筛选</text>
        <view class="filter-options">
          <view 
            class="filter-option {{selectedPriority === item.value ? 'active' : ''}}"
            wx:for="{{priorities}}" 
            wx:key="value"
            bindtap="onPriorityFilter"
            data-priority="{{item.value}}"
          >
            <text>{{item.label}}</text>
          </view>
        </view>
      </view>
      
      <!-- 表单筛选 -->
      <view class="filter-section">
        <text class="filter-title">表单筛选</text>
        <view class="filter-options">
          <view 
            class="filter-option {{selectedForm === item.value ? 'active' : ''}}"
            wx:for="{{forms}}" 
            wx:key="value"
            bindtap="onFormFilter"
            data-form="{{item.value}}"
          >
            <text>{{item.label}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 筛选按钮 -->
  <view class="filter-actions">
    <view class="filter-toggle" bindtap="toggleFilterPanel">
      <icon name="filter" size="16" color="#64748B"></icon>
      <text>筛选</text>
    </view>
    <view class="filter-reset" bindtap="resetFilters">
      <text>重置</text>
    </view>
  </view>

  <!-- 任务列表 -->
  <view class="task-list {{viewMode}}">
    <view 
      class="task-card {{item.isOverdue ? 'overdue' : ''}} {{item.priority}}"
      wx:for="{{filteredTasks}}" 
      wx:key="id"
    >
      <view class="task-header">
        <view class="task-title-section">
          <view class="task-title">{{item.title}}</view>
          <view class="task-priority {{item.priority}}">
            <text>{{item.priority === 'high' ? '高' : item.priority === 'medium' ? '中' : '低'}}</text>
          </view>
        </view>
        <view class="task-status">
          <text class="status-tag {{item.status}}">
            {{item.status === 'pending' ? '待处理' : item.status === 'in_progress' ? '进行中' : item.status === 'completed' ? '已完成' : '已逾期'}}
          </text>
        </view>
      </view>
      
      <view class="task-info">
        <view class="task-meta">
          <view class="meta-item">
            <icon name="form-fill" size="14" color="#64748B"></icon>
            <text>{{item.formTitle}}</text>
          </view>
          <view class="meta-item">
            <icon name="user" size="14" color="#64748B"></icon>
            <text>执行人：{{item.assignee}}</text>
          </view>
          <view class="meta-item">
            <icon name="user-management" size="14" color="#64748B"></icon>
            <text>分派人：{{item.assigner}}</text>
          </view>
          <view class="meta-item">
            <icon name="calendar" size="14" color="#64748B"></icon>
            <text class="task-deadline {{item.isOverdue ? 'overdue' : ''}}">
              {{item.isOverdue ? '已逾期：' : '截止：'}}{{item.deadline}}
            </text>
          </view>
        </view>
        
        <view class="task-progress">
          <view class="progress-info">
            <text class="progress-text">{{item.submitted}}/{{item.total}} 已提交</text>
            <text class="progress-percent">{{item.progress}}%</text>
          </view>
          <view class="progress-bar">
            <view class="progress-fill {{item.status}}" style="width: {{item.progress}}%"></view>
          </view>
        </view>
      </view>
      
      <view class="task-actions">
        <view class="action-item" bindtap="viewTaskDetail" data-taskId="{{item.id}}">
          <icon name="eye" size="14" color="#007BFF"></icon>
          <text>查看</text>
        </view>
        <view class="action-item primary" bindtap="fillForm" data-taskId="{{item.id}}" wx:if="{{item.status !== 'completed'}}">
          <icon name="form-fill" size="14" color="#FFFFFF"></icon>
          <text>填写</text>
        </view>
        <view class="action-item completed" wx:if="{{item.status === 'completed'}}">
          <icon name="check" size="14" color="#10B981"></icon>
          <text>已完成</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 空状态 -->
  <view wx:if="{{filteredTasks.length === 0 && !loading}}" class="empty-state">
    <view class="empty-icon">
      <icon name="records" size="64" color="#CBD5E1"></icon>
    </view>
    <view class="empty-content">
      <text class="empty-title">暂无任务</text>
      <text class="empty-desc">没有找到符合条件的任务</text>
    </view>
  </view>

  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-state">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>
</view>

<view class="container">
  <!-- 页面头部 -->
  <view class="header">
    <view class="header-content">
      <text class="header-title">表单进度</text>
      <text class="header-subtitle">{{formData.title}}</text>
    </view>
    <button class="export-btn" bindtap="showExportModal">
      <icon name="download" size="20" color="white"></icon>
      <text>导出数据</text>
    </button>
  </view>

  <!-- 进度统计 -->
  <view class="progress-stats">
    <view class="stats-grid">
      <view class="stat-item">
        <view class="stat-number">{{progressStats.total}}</view>
        <view class="stat-label">总人数</view>
      </view>
      <view class="stat-item">
        <view class="stat-number">{{progressStats.submitted}}</view>
        <view class="stat-label">已提交</view>
      </view>
      <view class="stat-item">
        <view class="stat-number">{{progressStats.pending}}</view>
        <view class="stat-label">待填写</view>
      </view>
      <view class="stat-item">
        <view class="stat-number">{{progressStats.completionRate}}%</view>
        <view class="stat-label">完成率</view>
      </view>
    </view>
    
    <!-- 进度条 -->
    <view class="progress-bar">
      <view class="progress-fill" style="width: {{progressStats.completionRate}}%"></view>
    </view>
  </view>

  <!-- 用户列表 -->
  <view class="users-section">
    <view class="section-header">
      <text class="section-title">用户填写状态</text>
      <text class="section-count">({{distributions.length}})</text>
    </view>
    
    <view class="users-list" wx:if="{{distributions.length > 0}}">
      <view class="user-item" wx:for="{{distributions}}" wx:key="userId">
        <view class="user-info">
          <image class="user-avatar" 
                 src="/images/avatar.png" 
                 mode="aspectFill"></image>
          <view class="user-details">
            <text class="user-name">{{item.userName || '未知用户'}}</text>
            <text class="user-id">ID: {{item.userId}}</text>
            <text class="user-department">{{item.userDepartment || '未知部门'}}</text>
          </view>
        </view>
        
        <view class="user-status">
          <view class="status-badge" style="color: {{item.status === 'completed' ? '#28a745' : item.status === 'pending' ? '#ffc107' : '#6c757d'}}">
            {{item.status === 'completed' ? '已提交' : item.status === 'pending' ? '待填写' : '未知'}}
          </view>
          <text class="submit-time" wx:if="{{item.submitTime}}">
            提交时间: {{item.submitTime}}
          </text>
          <text class="distribute-time">
            分发时间: {{item.createTime}}
          </text>
        </view>
        
        <view class="user-actions">
          <button class="action-btn info" 
                  wx:if="{{item.submission}}"
                  data-user-id="{{item.userId}}"
                  bindtap="viewUserDetail">
            查看详情
          </button>
          <button class="action-btn warning" 
                  wx:if="{{item.submission}}"
                  data-user-id="{{item.userId}}"
                  bindtap="redistributeForm">
            重新分发
          </button>
          <button class="action-btn secondary" 
                  wx:if="{{!item.submission}}"
                  data-user-id="{{item.userId}}"
                  bindtap="sendReminder">
            发送提醒
          </button>
        </view>
      </view>
    </view>
    
    <view class="empty-state" wx:else>
      <image class="empty-icon" src="/images/create_cbr.png" mode="aspectFit"></image>
      <text class="empty-text">还没有分发记录</text>
      <text class="empty-hint">请先分发表单给用户</text>
    </view>
  </view>

  <!-- 导出模态框 -->
  <view class="modal-overlay" wx:if="{{showExportModal}}" bindtap="hideExportModal">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">导出表单数据</text>
        <text class="modal-close" bindtap="hideExportModal">×</text>
      </view>
      
      <view class="modal-body">
        <view class="export-options">
          <view class="option-group">
            <text class="option-label">导出格式:</text>
            <radio-group class="format-options" bindchange="onExportFormatChange">
              <label class="format-option">
                <radio value="excel" checked="{{exportFormat === 'excel'}}" />
                <text>Excel (.xlsx)</text>
              </label>
              <label class="format-option">
                <radio value="csv" checked="{{exportFormat === 'csv'}}" />
                <text>CSV (.csv)</text>
              </label>
            </radio-group>
          </view>
          
          <view class="export-preview">
            <text class="preview-title">导出内容预览:</text>
            <view class="preview-content">
              <text class="preview-item">• 用户基本信息</text>
              <text class="preview-item">• 填写状态</text>
              <text class="preview-item">• 表单字段值</text>
              <text class="preview-item">• 时间信息</text>
            </view>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="modal-btn secondary" bindtap="hideExportModal">取消</button>
        <button class="modal-btn primary" bindtap="exportFormData">
          确认导出
        </button>
      </view>
    </view>
  </view>

  <!-- 加载状态 -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>
</view>
